# -- generate keys for users
users="<%= @key_users %>"
pg_datadir="<%= @datadir %>"
organization='Engine Yard'     # don't change this, customer names can change, we'd have to re-generate the server key

for user in ${users}
do
  cd <%= @dataroot %>
  temppath="./pgkeygen/${user}"
  mkdir -p ${temppath}
  cd ${temppath}
  openssl genrsa -des3 -passout pass:$(cat ~/.pgpass|awk -F: '{print $5}') -out postgresql.key 1024
  openssl rsa -passin pass:$(cat ~/.pgpass|awk -F: '{print $5}') -in postgresql.key -out postgresql.key
  openssl req -new -key postgresql.key -out postgresql.csr -subj "/C=US/ST=California/L=San Francisco/O=${organization}/CN=${user}"
  openssl x509 -req -in postgresql.csr -days 3650 -CA ${pg_datadir}/root.crt -CAkey ${pg_datadir}/server.key -out postgresql.crt -CAcreateserial
  cd <%= @dataroot %>
done